# Домашнее задание 11

### Тема лекции
> "o11y sheet или Наблюдаемость на одном листе"

### Среда выполнения
> 

### Задание

**Цель домашнего задания** - сделать аналог приложения показанного на лекции (часть 2). Пользоваться можно и нужно чем угодно (кроме прямого списывания).

Проверка будет осуществляться путём захода на ваш сайт (можно без домена). Все проверки осуществляются в браузере + переход в ваш ТГ канал.

#### Что нужно сделать:

0) README того что сделано, куда смотреть и т.п. Документация должна быть за ручкой (например /docs) чтобы открыть её в браузере.
1) Сервис (бизнес логика может быть любой). Важно описать в документации что именно вы сделали. Можете взять любой готовый код если он вам подойдет. 

2) Нагрузочный Сервис (можно использовать что-то стандартное или написать своё). Важно чтобы проверяющий мог через UI нагрузить ваш сервис, меняя кол-во rps (профиль нагрузки значения не имеет). 
3) БД (любая БД в которой можете хранить состояние).
4) Графики/Алерты  (Сервиса + БД (!)).
  - Графики:
    Вы должны предоставить графики своего целевого приложения, чтобы проверяющий после роста нагрузки мог увидеть метрики.
Также важно предоставить метрики БД (например кол-во запросов в этот момент в БД, латенси и т.п). Графики можно показывать любые, в т.ч. встроенные в платформу деплоя. Важно чтобы они были корректными. Если в нагрузочном тестировании вы указали 100rps а на графиках будет 25 - это косяк и считается пункт невыполненным.
 - Алерты в ТГ в public канал (чтобы по ссылке открывался) 
Необходимо реализовать 2 алерта:
   1) Если время ответа на целевую ручку в p99 превысила 500ms (подберите пожалуйста нагрузку / костыли в коде чтобы такое было реализуемо и напишите в README как это воспроизвести)
   2) кол-во rps в БД больше 100

В этих случаях мы должны отправить сигнал в телеграмм канал. Сигнал должен понятно описан.
 
В решении вы должны приложить ссылку на этот ТГ канал, чтобы проверяющий мог запустить ваш нагрузочный UI и убедиться что алерты шлются, и шлются корректно. 

5) IAC Алерты и графики должны быть под IAC. У вас должны быть конфиги с помощью которых вы это настроили. Например, если это график в графане - то готовый дашборд который лежит в коде и вы его "настраиваете" условно курлом. Можете использовать тераформ, json и т.п. В редми должно быть указано где это лежит в коде (ссылкой на гитхаб)

----
Эти пункты необходимый минимум - без этого домашка считается не выполненной и оценивается в 0 баллов. 

За минимум вы получаете 5 баллов. Дальше за каждый бонус идет по 1 баллу дополнительно.

#### Дальше идут бонусы. 

#### Общие бонусы

6) swagger или другой любой инструмент для работы с api. Инструмент должен показывать ручки и мочь их запускать. 
7) Трейсинг типа jaeger. Можно использовать тот что в графане. Можете хоть свой написать. Главный критерий - связь между запросами сервиса и нагрузочного показанная в каком-то инструменте.
8) Использование перфоманс инструмента. Скринкаст с тем как вы дебажите искусственно (или нет) созданную проблему в коде. В инструменте вам должны показать точную строчку или подстроку с проблемой после чего вы её должны пофиксить, пересобрать и показать что всё хорошо. Можно взять пример из лекции или что-то такое. 

Постарайтесь использовать языко-специфичные инструменты

#### Кастомные бонусы

Кастомные бонусы которые зависят от времени сдачи и призваны поощрить людей которые решают быстрее + не списывают у коллег. Отсортируем по времени посылки решений. Среди всех решений балл начисляется тем кто войдет в число первых 5 (пяти). 

9) "Новая" БД  (для стораджа под приложением)
10) "Новый" язык программирования. (для самого приложения которое мониторим)

---
Итого к этому моменту вы могли заработать 10 баллов.

### Решение

#### Изучаем документацию

```bash
root
├── README.md           ← пошаговый туториал (см. ниже)
├── docs/               ← сгенерированный OpenAPI-yaml + ReDoc-HTML
│   └── index.html      ← отдаётся как /docs
└── ...
```

README.md включает:
	•	схема архитектуры (ascii-диаграмма + PNG)
	•	инструкция «как поднять всё в docker compose»
	•	«как воспроизвести алерты» (см. шаг 4)
	•	ссылки на публичный ТГ-канал и дашборды Grafana
	•	список всех IaC-файлов

#### Бизнес-сервис (Rust + Actix)

Метод - Путь - Описание
GET - /api/ping - healthcheck для Prometheus
GET - /api/items - вернуть список объектов (limit/offset)
POST - /api/items - создать объект {name, price}
GET - /api/items/:id - вернуть один объект

- Метрики: opentelemetry + prometheus экспорт
(/metrics на том же порту).
- OpenAPI генерируется с помощью utoipa → openapi.yaml.
Собранная ReDoc-страница лежит в docs/.

#### Нагрузочный сервис

- Используем Locust (UI из коробки).
В load/locustfile.py один сценарий UserBehaviour с RPS = 1 .. 1000.
В README:
  1.	docker compose up locust
	2.	открыть http://localhost:8089, вставить хост http://service:8080,
задать пользователей/спавн-rate — Locust сам стабилизирует RPS.

#### База данных

- CockroachDB односегментарный контейнер (cockroach start-single-node).
- В сервисе используем драйвер sqlx.
-	Метрики БД экспортируются по :9090/_status/vars.

#### Графики и алерты

**Prometheus**
	•	prometheus/prometheus.yml собирает
	•	service:8080/metrics
	•	cockroach:9090/_status/vars
	•	locust:9646/metrics (у Locust есть Prometheus-плагин)

**Grafana**
	•	grafana/provisioning/dashboards/*.json
	•	Service overview (RPS, p50/p95/p99 latency, error %)
	•	Cockroach overview (qps, latency, CPU, disk)
	•	Load overview (Locust actual RPS vs requested)

#### Alertmanager → Telegram

```yaml
# alertmanager/config.yml
receivers:
- name: "telegram"
  telegram_configs:
  - bot_token: ${TG_BOT_TOKEN}
    chat_id:  "@o11y_sheet_hw11"     # публичный канал
```

Rule 1 — p99 > 500 ms 2 м подряд:

```yaml
- alert: HighLatencyP99
  expr: histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{job="service"}[1m])) by (le)) > 0.5
  for: 2m
  labels:
    severity: warning
  annotations:
    summary: "p99 latency {{ $value }} s"
```

Rule 2 — DB RPS > 100:

```yaml
- alert: HighDBQPS
  expr: rate(cockroach_sql_select_count_total[1m]) > 100
  for: 30s
```